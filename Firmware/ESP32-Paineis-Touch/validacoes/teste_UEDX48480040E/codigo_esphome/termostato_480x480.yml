## UEDX48480040E-WB-A - Display 4" 480x480 Touch Capacitivo ##
## Termostato Piso Aquecido - Interface LVGL Otimizada ##
## Driver: GC9503V (RGB Paralelo) + FT6336U (Touch I2C) ##

substitutions:
  devicename: termostato-piso
  friendly_name: "Termostato Piso"

esphome:
  name: ${devicename}
  friendly_name: ${friendly_name}
  platformio_options:
    build_flags: "-DBOARD_HAS_PSRAM"
    board_build.arduino.memory_type: qio_opi
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 16MB
  framework:
    type: esp-idf

psram:
  mode: octal
  speed: 80MHz

# ============================================
# Variaveis Globais - Termostato
# ============================================
globals:
  - id: target_temp
    type: float
    initial_value: '22.0'
  - id: current_temp
    type: float
    initial_value: '20.5'
  - id: is_heating
    type: bool
    initial_value: 'false'
  - id: is_enabled
    type: bool
    initial_value: 'true'

# ============================================
# Logging e Conectividade
# ============================================
logger:
  level: INFO

api:

ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${devicename}-AP"
    password: "termostato123"

captive_portal:

# ============================================
# SPI para inicializacao do display GC9503V
# ============================================
spi:
  id: my_spi
  clk_pin: 48
  mosi_pin: 47

# ============================================
# I2C para Touchscreen FT6336U
# ============================================
i2c:
  sda: GPIO40
  scl: GPIO41
  scan: true
  id: i2c_touch

# ============================================
# Backlight (PWM)
# ============================================
output:
  - platform: ledc
    pin: GPIO38
    frequency: 10000Hz
    id: backlight_pwm

light:
  - platform: monochromatic
    output: backlight_pwm
    name: "${friendly_name} Backlight"
    id: backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 500ms

# ============================================
# Display GC9503V - RGB Paralelo 480x480
# ============================================
display:
  - platform: mipi_rgb
    model: CUSTOM
    id: main_display
    color_order: RGB
    dimensions:
      width: 480
      height: 480  
    de_pin:
      number: 18
      inverted: false
    hsync_pin:
      number: 16
      inverted: false
    vsync_pin:
      number: 17
      inverted: false
    pclk_pin: 21
    pclk_inverted: false
    pclk_frequency: 17MHz
    hsync_pulse_width: 8
    hsync_back_porch: 40
    hsync_front_porch: 40
    vsync_pulse_width: 2
    vsync_back_porch: 4
    vsync_front_porch: 16
    data_pins:
      red: [4, 3, 2, 1, 0]
      green: [10, 9, 8, 7, 6, 5]
      blue: [15, 14, 13, 12, 11]
    spi_id: my_spi
    cs_pin: 39
    reset_pin: 44
    init_sequence:
      - delay 150ms
      - [0xf0, 0x55, 0xaa, 0x52, 0x08, 0x00]
      - [0xf6, 0x5a, 0x87]
      - [0xc1, 0x3f]
      - [0xc2, 0x0e]
      - [0xc6, 0xf8]
      - [0xc9, 0x10]
      - [0xcd, 0x25]
      - [0xf8, 0x8a]
      - [0xac, 0x45]
      - [0xa0, 0xdd]
      - [0xa7, 0x47]
      - [0xfa, 0x00, 0x00, 0x00, 0x04]
      - [0x86, 0x99, 0xa3, 0xa3, 0x51]
      - [0xa3, 0xee]
      - [0xfd, 0x3c, 0x3c, 0x00]
      - [0x71, 0x48]
      - [0x72, 0x48]
      - [0x73, 0x00, 0x44]
      - [0x97, 0xee]
      - [0x83, 0x93]
      - [0x9a, 0x72]
      - [0x9b, 0x5a]
      - [0x82, 0x2c, 0x2c]
      - [0x6d, 0x00, 0x1f, 0x19, 0x1a, 0x10, 0x0e, 0x0c, 0x0a, 0x02, 0x07, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e,
                        0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x08, 0x01, 0x09, 0x0b, 0x0d, 0x0f, 0x1a, 0x19, 0x1f, 0x00]
      - [0x64, 0x38, 0x05, 0x01, 0xdb, 0x03, 0x03, 0x38, 0x04, 0x01, 0xdc, 0x03, 0x03, 0x7a, 0x7a, 0x7a, 0x7a]
      - [0x65, 0x38, 0x03, 0x01, 0xdd, 0x03, 0x03, 0x38, 0x02, 0x01, 0xde, 0x03, 0x03, 0x7a, 0x7a, 0x7a, 0x7a]
      - [0x66, 0x38, 0x01, 0x01, 0xdf, 0x03, 0x03, 0x38, 0x00, 0x01, 0xe0, 0x03, 0x03, 0x7a, 0x7a, 0x7a, 0x7a]
      - [0x67, 0x30, 0x01, 0x01, 0xe1, 0x03, 0x03, 0x30, 0x02, 0x01, 0xe2, 0x03, 0x03, 0x7a, 0x7a, 0x7a, 0x7a]
      - [0x68, 0x00, 0x08, 0x15, 0x08, 0x15, 0x7a, 0x7a, 0x08, 0x15, 0x08, 0x15, 0x7a, 0x7a]
      - [0x60, 0x38, 0x08, 0x7a, 0x7a, 0x38, 0x09, 0x7a, 0x7a]
      - [0x63, 0x31, 0xe4, 0x7a, 0x7a, 0x31, 0xe5, 0x7a, 0x7a]
      - [0x69, 0x04, 0x22, 0x14, 0x22, 0x14, 0x22, 0x08]
      - [0x6b, 0x07]
      - [0x7a, 0x08, 0x13]
      - [0x7b, 0x08, 0x13]
      - [0xd1, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03, 0xff]
      - [0xd2, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03, 0xff]
      - [0xd3, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03, 0xff]
      - [0xd4, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03, 0xff]
      - [0xd5, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03, 0xff]
      - [0xd6, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03, 0xff]
      - [0x11]
      - delay 120ms
      - [0x29]
      - delay 20ms
      - [0x00]

# ============================================
# Touchscreen FT6336U
# ============================================
touchscreen:
  - platform: ft63x6
    id: main_touch
    i2c_id: i2c_touch
    display: main_display
    on_release:
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:
            - light.turn_on: backlight

# ============================================
# Fontes - Otimizadas para 480x480
# ============================================
font:
  # Labels pequenos
  - file: "gfonts://Roboto"
    id: font_small
    size: 20
    bpp: 4

  # Labels medios
  - file: "gfonts://Roboto"
    id: font_medium
    size: 28
    bpp: 4

  # Labels grandes
  - file: "gfonts://Roboto@500"
    id: font_large
    size: 42
    bpp: 4

  # Temperatura ENORME no centro
  - file: "gfonts://Roboto@300"
    id: font_temp_huge
    size: 140
    bpp: 4

  # Temperatura grande
  - file: "gfonts://Roboto@300"
    id: font_temp_large
    size: 72
    bpp: 4

  # Graus Celsius
  - file: "gfonts://Roboto@300"
    id: font_celsius
    size: 48
    bpp: 4

  # Icones Material Design
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_32
    size: 32
    bpp: 4
    glyphs: [
      "\U000F0238",  # fire
      "\U000F0E0E",  # fire-off  
      "\U000F050F",  # thermometer
      "\U000F0210",  # cog (config)
      "\U000F0419",  # minus
      "\U000F0415",  # plus
      "\U000F004D",  # arrow-left
      "\U000F0054",  # arrow-right
      "\U000F0156",  # check
      "\U000F0F52",  # home-thermometer
      "\U000F18B6"   # floor-lamp (piso)
    ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_48
    size: 48
    bpp: 4
    glyphs: [
      "\U000F0238",  # fire
      "\U000F0419",  # minus
      "\U000F0415",  # plus
      "\U000F0F52"   # home-thermometer
    ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_80
    size: 80
    bpp: 4
    glyphs: [
      "\U000F0419",  # minus
      "\U000F0415"   # plus
    ]

# ============================================
# LVGL - Interface Termostato 480x480
# ============================================
lvgl:
  buffer_size: 50%
  displays:
    - main_display
  touchscreens:
    - main_touch
  color_depth: 16
  bg_color: 0x000000
  
  style_definitions:
    # ========== CORES DO TEMA ==========
    - id: style_card
      bg_color: 0x1a1a1a
      bg_opa: COVER
      radius: 24
      border_width: 0
      pad_all: 20

    - id: style_card_highlight
      bg_color: 0x2a2a2a
      bg_opa: COVER
      radius: 20
      border_width: 2
      border_color: 0xFF5722
      pad_all: 15

    # ========== BOTOES ==========
    - id: style_btn_circle
      bg_color: 0x2a2a2a
      bg_opa: COVER
      radius: 100
      border_width: 3
      border_color: 0xFF5722
      
    - id: style_btn_circle_pressed
      bg_color: 0xFF5722
      border_color: 0xFF8A50

    - id: style_btn_nav
      bg_color: 0x333333
      bg_opa: COVER
      radius: 12
      border_width: 0
      pad_all: 12

    - id: style_btn_nav_pressed
      bg_color: 0x555555

    # ========== ARC ==========
    - id: style_arc_bg
      arc_width: 30
      arc_color: 0x333333
      arc_rounded: true
      bg_opa: TRANSP
      
    - id: style_arc_indicator
      arc_width: 30
      arc_color: 0xFF5722
      arc_rounded: true

    - id: style_arc_knob
      bg_color: 0xFFFFFF
      bg_opa: COVER
      radius: 100
      pad_all: 8

  on_idle:
    - timeout: 60s
      then:
        - light.turn_on:
            id: backlight
            brightness: 30%
    - timeout: 180s
      then:
        - light.turn_off: backlight
        - lvgl.pause:

  pages:
    # ==========================================
    # PAGINA PRINCIPAL - Controle de Temperatura
    # ==========================================
    - id: page_main
      widgets:
        # ---------- HEADER ----------
        # Icone Home + Titulo
        - label:
            text: "\U000F0F52"
            text_font: icons_32
            text_color: 0xFF5722
            x: 25
            y: 20

        - label:
            text: "Piso Aquecido"
            text_font: font_medium
            text_color: 0xFFFFFF
            x: 65
            y: 22

        # Status aquecimento (direita)
        - label:
            id: lbl_heating_status
            text: "\U000F0238"
            text_font: icons_32
            text_color: 0x444444
            align: top_right
            x: -25
            y: 20

        # ---------- TEMPERATURA ATUAL (card superior) ----------
        - obj:
            x: 25
            y: 70
            width: 430
            height: 90
            styles: style_card
            widgets:
              - label:
                  text: "Temperatura Atual"
                  text_font: font_small
                  text_color: 0x888888
                  x: 15
                  y: 10
              
              - label:
                  id: lbl_current_temp
                  text: "20.5"
                  text_font: font_temp_large
                  text_color: 0xFFFFFF
                  x: 15
                  y: 25

              - label:
                  text: "C"
                  text_font: font_celsius
                  text_color: 0x888888
                  x: 130
                  y: 30

        # ---------- CONTROLE CENTRAL ----------
        # Botao DIMINUIR (-)
        - button:
            x: 30
            y: 200
            width: 100
            height: 100
            styles: style_btn_circle
            pressed:
              styles: style_btn_circle_pressed
            widgets:
              - label:
                  text: "\U000F0419"
                  text_font: icons_80
                  text_color: 0xFFFFFF
                  align: center
            on_click:
              - lambda: |-
                  if (id(target_temp) > 15.0) {
                    id(target_temp) -= 0.5;
                  }
              - lvgl.label.update:
                  id: lbl_target_temp
                  text:
                    format: "%.1f"
                    args: ['id(target_temp)']

        # Display Temperatura Desejada (CENTRO)
        - obj:
            align: center
            y: 10
            width: 220
            height: 160
            bg_opa: TRANSP
            border_width: 0
            widgets:
              - label:
                  text: "Desejado"
                  text_font: font_small
                  text_color: 0x888888
                  align: top_mid

              - label:
                  id: lbl_target_temp
                  text: "22.0"
                  text_font: font_temp_huge
                  text_color: 0xFF5722
                  align: center
                  y: 10

              - label:
                  text: "C"
                  text_font: font_celsius
                  text_color: 0xFF5722
                  align: center
                  x: 95
                  y: -15

        # Botao AUMENTAR (+)
        - button:
            align: top_right
            x: -30
            y: 200
            width: 100
            height: 100
            styles: style_btn_circle
            pressed:
              styles: style_btn_circle_pressed
            widgets:
              - label:
                  text: "\U000F0415"
                  text_font: icons_80
                  text_color: 0xFFFFFF
                  align: center
            on_click:
              - lambda: |-
                  if (id(target_temp) < 35.0) {
                    id(target_temp) += 0.5;
                  }
              - lvgl.label.update:
                  id: lbl_target_temp
                  text:
                    format: "%.1f"
                    args: ['id(target_temp)']

        # ---------- FOOTER - Botoes de acao ----------
        # Botao ON/OFF
        - button:
            id: btn_power
            x: 25
            y: 390
            width: 200
            height: 70
            styles: style_card_highlight
            widgets:
              - label:
                  id: lbl_power_icon
                  text: "\U000F0238"
                  text_font: icons_32
                  text_color: 0xFF5722
                  x: 15
                  align: left_mid
              - label:
                  id: lbl_power_text
                  text: "Ligado"
                  text_font: font_medium
                  text_color: 0xFFFFFF
                  x: 60
                  align: left_mid
            on_click:
              - lambda: "id(is_enabled) = !id(is_enabled);"
              - if:
                  condition:
                    lambda: "return id(is_enabled);"
                  then:
                    - lvgl.label.update:
                        id: lbl_power_text
                        text: "Ligado"
                    - lvgl.label.update:
                        id: lbl_power_icon
                        text_color: 0xFF5722
                  else:
                    - lvgl.label.update:
                        id: lbl_power_text
                        text: "Desligado"
                    - lvgl.label.update:
                        id: lbl_power_icon
                        text_color: 0x555555

        # Botao Modo (vai para pagina 2)
        - button:
            align: top_right
            x: -25
            y: 390
            width: 200
            height: 70
            styles: style_card
            widgets:
              - label:
                  text: "\U000F0210"
                  text_font: icons_32
                  text_color: 0x888888
                  x: 15
                  align: left_mid
              - label:
                  text: "Ajustes"
                  text_font: font_medium
                  text_color: 0xAAAAAA
                  x: 60
                  align: left_mid
            on_click:
              - lvgl.page.next:
                  animation: MOVE_LEFT
                  time: 200ms

    # ==========================================
    # PAGINA 2 - Ajuste com ARC (Dial)
    # ==========================================
    - id: page_dial
      widgets:
        # Header
        - button:
            x: 20
            y: 15
            width: 50
            height: 50
            styles: style_btn_nav
            pressed:
              styles: style_btn_nav_pressed
            widgets:
              - label:
                  text: "\U000F004D"
                  text_font: icons_32
                  text_color: 0xFFFFFF
                  align: center
            on_click:
              - lvgl.page.previous:
                  animation: MOVE_RIGHT
                  time: 200ms

        - label:
            text: "Ajuste Fino"
            text_font: font_large
            text_color: 0xFFFFFF
            align: top_mid
            y: 25

        # ARC circular (aproveita formato quadrado)
        - arc:
            id: arc_temp
            align: center
            width: 380
            height: 380
            min_value: 15
            max_value: 35
            value: !lambda "return (int)(id(target_temp) * 2);"
            adjustable: true
            rotation: 135
            arc_width: 30
            start_angle: 0
            end_angle: 270
            
            main:
              styles: style_arc_bg
            indicator:
              styles: style_arc_indicator
            knob:
              styles: style_arc_knob
            
            on_value:
              - lambda: "id(target_temp) = x / 2.0;"
              - lvgl.label.update:
                  id: lbl_arc_temp
                  text:
                    format: "%.1f"
                    args: ['id(target_temp)']
        
        # Temperatura no centro do arc
        - obj:
            align: center
            width: 200
            height: 150
            bg_opa: TRANSP
            border_width: 0
            widgets:
              - label:
                  id: lbl_arc_temp
                  text: "22.0"
                  text_font: font_temp_large
                  text_color: 0xFFFFFF
                  align: center
                  y: -10
              
              - label:
                  text: "C"
                  text_font: font_celsius
                  text_color: 0x888888
                  align: center
                  x: 65
                  y: -25

              - label:
                  text: "Desejado"
                  text_font: font_small
                  text_color: 0x888888
                  align: bottom_mid
                  y: -15

        # Range info
        - label:
            text: "15"
            text_font: font_medium
            text_color: 0x555555
            x: 55
            y: 400

        - label:
            text: "35"
            text_font: font_medium
            text_color: 0x555555
            align: top_right
            x: -55
            y: 400

    # ==========================================
    # PAGINA 3 - Status do Sistema
    # ==========================================
    - id: page_status
      widgets:
        # Header
        - button:
            x: 20
            y: 15
            width: 50
            height: 50
            styles: style_btn_nav
            pressed:
              styles: style_btn_nav_pressed
            widgets:
              - label:
                  text: "\U000F004D"
                  text_font: icons_32
                  text_color: 0xFFFFFF
                  align: center
            on_click:
              - lvgl.page.previous:
                  animation: MOVE_RIGHT
                  time: 200ms

        - label:
            text: "Status"
            text_font: font_large
            text_color: 0xFFFFFF
            align: top_mid
            y: 25

        # Card Status
        - obj:
            x: 25
            y: 85
            width: 430
            height: 370
            styles: style_card
            widgets:
              # Sistema
              - label:
                  text: "Sistema"
                  text_font: font_medium
                  text_color: 0xFF5722
                  y: 5

              - label:
                  text: "Display: UEDX48480040E"
                  text_font: font_small
                  text_color: 0xAAAAAA
                  y: 45

              - label:
                  text: "MCU: ESP32-S3"
                  text_font: font_small
                  text_color: 0xAAAAAA
                  y: 75

              - label:
                  text: "Framework: ESPHome + LVGL"
                  text_font: font_small
                  text_color: 0xAAAAAA
                  y: 105

              # Separador
              - obj:
                  y: 145
                  width: 390
                  height: 2
                  bg_color: 0x333333
                  bg_opa: COVER
                  border_width: 0
                  radius: 1

              # Conexao
              - label:
                  text: "Conexao"
                  text_font: font_medium
                  text_color: 0xFF5722
                  y: 165

              - label:
                  id: lbl_wifi_status
                  text: "WiFi: Conectando..."
                  text_font: font_small
                  text_color: 0xAAAAAA
                  y: 205

              - label:
                  id: lbl_ip_address
                  text: "IP: ---.---.---.---"
                  text_font: font_small
                  text_color: 0xAAAAAA
                  y: 235

              # Separador
              - obj:
                  y: 275
                  width: 390
                  height: 2
                  bg_color: 0x333333
                  bg_opa: COVER
                  border_width: 0
                  radius: 1

              # Versao
              - label:
                  text: "Versao: 1.0.0"
                  text_font: font_small
                  text_color: 0x666666
                  y: 295

              - label:
                  text: "Guilas Automacao"
                  text_font: font_small
                  text_color: 0x666666
                  y: 320

# ============================================
# Sensores (opcional - descomentar se usar)
# ============================================
# sensor:
#   - platform: wifi_signal
#     name: "${friendly_name} WiFi Signal"
#     update_interval: 60s
#     on_value:
#       - lvgl.label.update:
#           id: lbl_wifi_status
#           text:
#             format: "WiFi: %.0f dBm"
#             args: ['x']

# text_sensor:
#   - platform: wifi_info
#     ip_address:
#       name: "${friendly_name} IP"
#       on_value:
#         - lvgl.label.update:
#             id: lbl_ip_address
#             text:
#               format: "IP: %s"
#               args: ['x.c_str()']
