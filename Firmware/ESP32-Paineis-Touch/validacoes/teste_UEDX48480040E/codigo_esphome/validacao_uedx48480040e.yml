## UEDX48480040E-WB-A - Display 4" 480x480 Touch Capacitivo ##
## Arquivo de Validacao - ESPHome + LVGL ##
## Driver: GC9503V (RGB Paralelo) + FT6336U (Touch I2C) ##

substitutions:
  devicename: validacao-uedx48480040e
  friendly_name: "Validacao Display 4pol"

esphome:
  name: "${name}"
  friendly_name: "${friendly_name}"
  project:
    name: "${project_name}"
    version: "${project_version}"
  min_version: 2024.11.0
  name_add_mac_suffix: false

esp32:
  board: esp32-s3-devkitc-1
  flash_size: 16MB
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y

psram:
  mode: octal
  speed: 80MHz

# ============================================
# Variaveis Globais para Teste
# ============================================
globals:
  - id: touch_x
    type: int
    initial_value: '0'
  - id: touch_y
    type: int
    initial_value: '0'
  - id: touch_count
    type: int
    initial_value: '0'
  - id: test_value
    type: float
    initial_value: '50.0'

# ============================================
# Logging e Conectividade
# ============================================
logger:
  level: DEBUG

api:

ota:
  - platform: esphome


wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${devicename}-AP"
    password: "validacao123"

captive_portal:

# ============================================
# SPI para inicializacao do display GC9503V
# ============================================
spi:
  id: my_spi
  clk_pin: 48
  mosi_pin: 47

# ============================================
# I2C para Touchscreen FT6336U
# ============================================
i2c:
  sda: GPIO40
  scl: GPIO41
  scan: true
  id: i2c_touch

# ============================================
# Backlight (PWM)
# ============================================
output:
  - platform: ledc
    pin: GPIO38
    frequency: 300Hz
    id: backlight_pwm

light:
  - platform: monochromatic
    output: backlight_pwm
    name: "${friendly_name} Backlight"
    id: backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 500ms

# ============================================
# Display GC9503V - RGB Paralelo 480x480
# ============================================
display:
  - platform: mipi_rgb
    model: CUSTOM
    id: main_display
    color_order: RGB
    dimensions:
      width: 480
      height: 480  
    de_pin:
      number: 18
      inverted: false
    hsync_pin:
      number: 16
      inverted: false
    vsync_pin:
      number: 17
      inverted: false
    pclk_pin: 21

    pclk_inverted: false
    pclk_frequency: 18MHz

    hsync_pulse_width: 8
    hsync_back_porch: 40
    hsync_front_porch: 40
    vsync_pulse_width: 2
    vsync_back_porch: 4
    vsync_front_porch: 16
    data_pins:
      red:
        - 4         # R1
        - 3         # R2
        - 2         # R3
        - 1          # R4
        - 0          # R5
      green:
        - 10         # G0
        - 9         # G1
        - 8         # G2
        - 7         # G3
        - 6         # G4
        - 5         # G5 
      blue:
        - 15         # B1
        - 14         # B2
        - 13         # B3
        - 12         # B4
        - 11         # B5
    spi_id: my_spi
    cs_pin: 39
    reset_pin: 44
    init_sequence:
      - [0xf0, 0x55, 0xaa, 0x52, 0x08, 0x00]
      - [0xf6, 0x5a, 0x87]
      - [0xc1, 0x3f]
      - [0xc2, 0x0e]
      - [0xc6, 0xf8]
      - [0xc9, 0x10]
      - [0xcd, 0x25]
      - [0xf8, 0x8a]
      - [0xac, 0x45]
      - [0xa0, 0xdd]
      - [0xa7, 0x47]
      - [0xfa, 0x00, 0x00, 0x00, 0x04]
      - [0x86, 0x99, 0xa3, 0xa3, 0x51]
      - [0xa3, 0xee]
      - [0xfd, 0x3c, 0x3c, 0x00]
      - [0x71, 0x48]
      - [0x72, 0x48]
      - [0x73, 0x00, 0x44]
      - [0x97, 0xee]
      - [0x83, 0x93]
      - [0x9a, 0x72]
      - [0x9b, 0x5a]
      - [0x82, 0x2c, 0x2c]
      - [0x6d, 0x00, 0x1f, 0x19, 0x1a, 0x10, 0x0e, 0x0c, 0x0a, 0x02, 0x07, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e,
                        0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x08, 0x01, 0x09, 0x0b, 0x0d, 0x0f, 0x1a, 0x19, 0x1f, 0x00]
      - [0x64, 0x38, 0x05, 0x01, 0xdb, 0x03, 0x03, 0x38, 0x04, 0x01, 0xdc, 0x03, 0x03, 0x7a, 0x7a, 0x7a, 0x7a]
      - [0x65, 0x38, 0x03, 0x01, 0xdd, 0x03, 0x03, 0x38, 0x02, 0x01, 0xde, 0x03, 0x03, 0x7a, 0x7a, 0x7a, 0x7a]
      - [0x66, 0x38, 0x01, 0x01, 0xdf, 0x03, 0x03, 0x38, 0x00, 0x01, 0xe0, 0x03, 0x03, 0x7a, 0x7a, 0x7a, 0x7a]
      - [0x67, 0x30, 0x01, 0x01, 0xe1, 0x03, 0x03, 0x30, 0x02, 0x01, 0xe2, 0x03, 0x03, 0x7a, 0x7a, 0x7a, 0x7a]
      - [0x68, 0x00, 0x08, 0x15, 0x08, 0x15, 0x7a, 0x7a, 0x08, 0x15, 0x08, 0x15, 0x7a, 0x7a]
      - [0x60, 0x38, 0x08, 0x7a, 0x7a, 0x38, 0x09, 0x7a, 0x7a]
      - [0x63, 0x31, 0xe4, 0x7a, 0x7a, 0x31, 0xe5, 0x7a, 0x7a]
      - [0x69, 0x04, 0x22, 0x14, 0x22, 0x14, 0x22, 0x08]
      - [0x6b, 0x07]
      - [0x7a, 0x08, 0x13]
      - [0x7b, 0x08, 0x13]
      - [0xd1, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03,
            0xff]
      - [0xd2, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03,
            0xff]
      - [0xd3, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03,
            0xff]
      - [0xd4, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03,
            0xff]
      - [0xd5, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03,
            0xff]
      - [0xd6, 0x00, 0x00, 0x00, 0x04, 0x00, 0x12, 0x00, 0x18, 0x00, 0x21, 0x00, 0x2a, 0x00, 0x35, 0x00, 0x47, 0x00,
            0x56, 0x00, 0x90, 0x00, 0xe5, 0x01, 0x68, 0x01, 0xd5, 0x01, 0xd7, 0x02, 0x36, 0x02, 0xa6, 0x02, 0xee,
            0x03, 0x48, 0x03, 0xa0, 0x03, 0xba, 0x03, 0xc5, 0x03, 0xd0, 0x03, 0xe0, 0x03, 0xea, 0x03, 0xfa, 0x03,
            0xff]
      - [0x11]
      - delay 120ms
      - [0x29]
      - delay 20ms
      - [0x00]



# ============================================
# Touchscreen FT6336U
# ============================================
touchscreen:
  - platform: ft63x6
    id: main_touch
    i2c_id: i2c_touch
    display: main_display
    on_touch:
      - lambda: |-
          id(touch_x) = touch.x;
          id(touch_y) = touch.y;
          id(touch_count)++;
      - lvgl.label.update:
          id: lbl_touch_coords
          text:
            format: "Touch: %d, %d"
            args: ['id(touch_x)', 'id(touch_y)']
      - lvgl.label.update:
          id: lbl_touch_count
          text:
            format: "Toques: %d"
            args: ['id(touch_count)']
    on_release:
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:
            - light.turn_on: backlight

# ============================================
# Fontes para LVGL
# ============================================
font:
  - file: "gfonts://Roboto"
    id: roboto_24
    size: 24
    bpp: 4

  - file: "gfonts://Roboto"
    id: roboto_32
    size: 32
    bpp: 4

  - file: "gfonts://Roboto@700"
    id: roboto_48_bold
    size: 48
    bpp: 4

  - file: "gfonts://Roboto@700"
    id: roboto_72_bold
    size: 72
    bpp: 4

  - file: "gfonts://Roboto"
    id: roboto_18
    size: 18
    bpp: 4

# ============================================
# LVGL - Interface de Validacao
# ============================================
lvgl:
  buffer_size: 50%
  displays:
    - main_display
  touchscreens:
    - main_touch
  color_depth: 16
  bg_color: 0x1a1a2e
  
  style_definitions:
    - id: style_title
      text_color: 0xFFFFFF
      text_font: roboto_32
    
    - id: style_subtitle
      text_color: 0x888888
      text_font: roboto_18
    
    - id: style_value_green
      text_color: 0x00FF88
      text_font: roboto_72_bold
    
    - id: style_value_orange
      text_color: 0xFF6B35
      text_font: roboto_48_bold
    
    - id: style_btn
      bg_color: 0x2d2d44
      bg_opa: COVER
      border_width: 2
      border_color: 0x00FF88
      radius: 15
      text_color: 0xFFFFFF
      text_font: roboto_24
      pad_all: 15
    
    - id: style_btn_pressed
      bg_color: 0x00FF88
      text_color: 0x1a1a2e
    
    - id: style_slider_main
      bg_color: 0x2d2d44
      bg_opa: COVER
      radius: 10
    
    - id: style_slider_indicator
      bg_color: 0x00FF88
      bg_opa: COVER
      radius: 10
    
    - id: style_slider_knob
      bg_color: 0xFFFFFF
      bg_opa: COVER
      radius: 20
      pad_all: 5

  on_idle:
    - timeout: 60s
      then:
        - logger.log: "Display idle - dimming backlight"
        - light.turn_on:
            id: backlight
            brightness: 30%
    - timeout: 120s
      then:
        - logger.log: "Display idle - turning off backlight"
        - light.turn_off: backlight
        - lvgl.pause:

  pages:
    # ==========================================
    # PAGINA 1: Teste de Display e Touch
    # ==========================================
    - id: page_test_display
      widgets:
        # Titulo
        - label:
            text: "VALIDACAO UEDX48480040E"
            align: top_mid
            y: 20
            styles: style_title

        - label:
            text: "Fase 1: Display + Touch"
            align: top_mid
            y: 60
            styles: style_subtitle

        # Status do display
        - obj:
            align: center
            y: -60
            width: 400
            height: 120
            bg_color: 0x2d2d44
            bg_opa: COVER
            radius: 20
            border_width: 0
            widgets:
              - label:
                  text: "DISPLAY OK"
                  styles: style_value_green
                  align: center
                  y: -10
              - label:
                  text: "480x480 RGB - GC9503V"
                  styles: style_subtitle
                  align: bottom_mid
                  y: -15

        # Coordenadas do touch
        - label:
            id: lbl_touch_coords
            text: "Touch: ---, ---"
            align: center
            y: 60
            text_font: roboto_24
            text_color: 0xFF6B35

        # Contador de toques
        - label:
            id: lbl_touch_count
            text: "Toques: 0"
            align: center
            y: 100
            text_font: roboto_18
            text_color: 0x888888

        # Botao para proxima pagina
        - button:
            align: bottom_mid
            y: -30
            width: 200
            height: 60
            styles: style_btn
            pressed:
              styles: style_btn_pressed
            widgets:
              - label:
                  text: "PROXIMO"
                  align: center
            on_click:
              - lvgl.page.next:
                  animation: MOVE_LEFT
                  time: 300ms

    # ==========================================
    # PAGINA 2: Teste de Slider (Simulando Termostato)
    # ==========================================
    - id: page_test_slider
      widgets:
        - label:
            text: "TESTE SLIDER"
            align: top_mid
            y: 20
            styles: style_title

        - label:
            text: "Fase 2: Interatividade LVGL"
            align: top_mid
            y: 60
            styles: style_subtitle

        # Valor atual
        - obj:
            align: center
            y: -40
            width: 300
            height: 150
            bg_opa: TRANSP
            border_width: 0
            widgets:
              - label:
                  id: lbl_slider_value
                  text: "50"
                  styles: style_value_green
                  align: center
              - label:
                  text: "Valor do Slider"
                  styles: style_subtitle
                  align: bottom_mid

        # Slider
        - slider:
            id: test_slider
            align: center
            y: 80
            width: 380
            height: 30
            min_value: 0
            max_value: 100
            value: 50
            main:
              styles: style_slider_main
            indicator:
              styles: style_slider_indicator
            knob:
              styles: style_slider_knob
            on_value:
              - globals.set:
                  id: test_value
                  value: !lambda "return x;"
              - lvgl.label.update:
                  id: lbl_slider_value
                  text:
                    format: "%.0f"
                    args: ['id(test_value)']

        # Navegacao
        - button:
            align: bottom_left
            x: 30
            y: -30
            width: 140
            height: 60
            styles: style_btn
            pressed:
              styles: style_btn_pressed
            widgets:
              - label:
                  text: "ANTERIOR"
                  align: center
            on_click:
              - lvgl.page.previous:
                  animation: MOVE_RIGHT
                  time: 300ms

        - button:
            align: bottom_right
            x: -30
            y: -30
            width: 140
            height: 60
            styles: style_btn
            pressed:
              styles: style_btn_pressed
            widgets:
              - label:
                  text: "PROXIMO"
                  align: center
            on_click:
              - lvgl.page.next:
                  animation: MOVE_LEFT
                  time: 300ms

    # ==========================================
    # PAGINA 3: Teste de Cores
    # ==========================================
    - id: page_test_colors
      widgets:
        - label:
            text: "TESTE DE CORES"
            align: top_mid
            y: 20
            styles: style_title

        - label:
            text: "Fase 3: Renderizacao RGB"
            align: top_mid
            y: 60
            styles: style_subtitle

        # Quadrados coloridos
        - obj:
            align: center
            x: -120
            y: -20
            width: 100
            height: 100
            bg_color: 0xFF0000
            bg_opa: COVER
            radius: 10
            border_width: 0

        - obj:
            align: center
            x: 0
            y: -20
            width: 100
            height: 100
            bg_color: 0x00FF00
            bg_opa: COVER
            radius: 10
            border_width: 0

        - obj:
            align: center
            x: 120
            y: -20
            width: 100
            height: 100
            bg_color: 0x0000FF
            bg_opa: COVER
            radius: 10
            border_width: 0

        # Labels das cores
        - label:
            text: "RED"
            align: center
            x: -120
            y: 60
            text_font: roboto_18
            text_color: 0xFF0000

        - label:
            text: "GREEN"
            align: center
            x: 0
            y: 60
            text_font: roboto_18
            text_color: 0x00FF00

        - label:
            text: "BLUE"
            align: center
            x: 120
            y: 60
            text_font: roboto_18
            text_color: 0x0000FF

        # Segunda linha de cores
        - obj:
            align: center
            x: -60
            y: 120
            width: 100
            height: 100
            bg_color: 0xFFFF00
            bg_opa: COVER
            radius: 10
            border_width: 0

        - obj:
            align: center
            x: 60
            y: 120
            width: 100
            height: 100
            bg_color: 0xFF00FF
            bg_opa: COVER
            radius: 10
            border_width: 0

        # Navegacao
        - button:
            align: bottom_left
            x: 30
            y: -30
            width: 140
            height: 60
            styles: style_btn
            pressed:
              styles: style_btn_pressed
            widgets:
              - label:
                  text: "ANTERIOR"
                  align: center
            on_click:
              - lvgl.page.previous:
                  animation: MOVE_RIGHT
                  time: 300ms

        - button:
            align: bottom_right
            x: -30
            y: -30
            width: 140
            height: 60
            styles: style_btn
            pressed:
              styles: style_btn_pressed
            widgets:
              - label:
                  text: "PROXIMO"
                  align: center
            on_click:
              - lvgl.page.next:
                  animation: MOVE_LEFT
                  time: 300ms

    # ==========================================
    # PAGINA 4: Status e Info
    # ==========================================
    - id: page_status
      widgets:
        - label:
            text: "STATUS DO SISTEMA"
            align: top_mid
            y: 20
            styles: style_title

        - label:
            text: "Fase 4: Conectividade"
            align: top_mid
            y: 60
            styles: style_subtitle

        # Info cards
        - obj:
            align: center
            y: 0
            width: 420
            height: 250
            bg_color: 0x2d2d44
            bg_opa: COVER
            radius: 20
            border_width: 0
            widgets:
              - label:
                  text: "Display: UEDX48480040E-WB-A"
                  x: 20
                  y: 20
                  text_font: roboto_18
                  text_color: 0xFFFFFF

              - label:
                  text: "Resolucao: 480x480 px"
                  x: 20
                  y: 50
                  text_font: roboto_18
                  text_color: 0xFFFFFF

              - label:
                  text: "Driver LCD: GC9503V (RGB)"
                  x: 20
                  y: 80
                  text_font: roboto_18
                  text_color: 0xFFFFFF

              - label:
                  text: "Touch: FT6336U (I2C)"
                  x: 20
                  y: 110
                  text_font: roboto_18
                  text_color: 0xFFFFFF

              - label:
                  text: "MCU: ESP32-S3 (16MB/8MB PSRAM)"
                  x: 20
                  y: 140
                  text_font: roboto_18
                  text_color: 0xFFFFFF

              - label:
                  text: "Framework: ESPHome + LVGL"
                  x: 20
                  y: 170
                  text_font: roboto_18
                  text_color: 0xFFFFFF

              - label:
                  id: lbl_wifi_status
                  text: "WiFi: Conectando..."
                  x: 20
                  y: 200
                  text_font: roboto_18
                  text_color: 0xFF6B35

        # Botao voltar ao inicio
        - button:
            align: bottom_mid
            y: -30
            width: 200
            height: 60
            styles: style_btn
            pressed:
              styles: style_btn_pressed
            widgets:
              - label:
                  text: "INICIO"
                  align: center
            on_click:
              - lvgl.page.show:
                  id: page_test_display
                  animation: FADE_IN
                  time: 300ms

# ============================================
# Sensores de Status
# ============================================
sensor:
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s
    on_value:
      - lvgl.label.update:
          id: lbl_wifi_status
          text:
            format: "WiFi: %.0f dBm"
            args: ['x']
          text_color: 0x00FF88

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP"
    ssid:
      name: "${friendly_name} SSID"


